<!DOCTYPE html>
<html>
<head>
    <title>SD Card Explorer</title>
</head>
<body>
    <h1>SD Card Explorer</h1>
    <ul id="fileList">
        <!-- File list will be dynamically populated here -->
    </ul>

    <script>
        const fileList = document.getElementById('fileList');

        async function getFiles() {
            const response = await fetch('/'); // Assuming ESP32 serves index.html
            const html = await response.text(); // Get the whole HTML from ESP32

            // Parse the HTML to extract the links, assuming structure from before
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');

            // Find the 'list' link and follow it
            const listLink = doc.querySelector('a[href="/list"]');

            if (listLink) {
                const listResponse = await fetch(listLink.href); // Get the list HTML
                const listHtml = await listResponse.text();
                const listDoc = parser.parseFromString(listHtml, 'text/html');

                const listItems = listDoc.querySelectorAll('#fileList li');

                fileList.innerHTML = ''; // Clear existing items
                listItems.forEach(item => {
                    fileList.appendChild(item); // Append each list item

                    const copyLink = item.querySelector('a[href^="/copy"]');
                    if (copyLink) {
                        copyLink.addEventListener('click', (event) => {
                            event.preventDefault();
                            const filename = copyLink.href.split("file=")[1];
                            copyFile(filename);
                        });
                    }
                   const deleteLink = item.querySelector('a[href^="/delete"]');
                    if (deleteLink) {
                        deleteLink.addEventListener('click', (event) => {
                            event.preventDefault();
                            const filename = deleteLink.href.split("file=")[1];
                            deleteFile(filename);
                        });
                    }
                });

            }

        }

       async function copyFile(filename) {
            try {
                const response = await fetch(`copy?file=${filename}`); // Access via ESP32's route
                const data = await response.text();
                alert(data);  // Show success/error message
                getFiles();   // Refresh file list
            } catch (error) {
                console.error("Error copying file:", error);
                alert("Failed to copy file");
            }
        }
        async function deleteFile(filename) {
           try {
                const response = await fetch(`delete?file=${filename}`); // Access via ESP32's route
                const data = await response.text();
                alert(data);  // Show success/error message
                getFiles();   // Refresh file list
            } catch (error) {
                console.error("Error copying file:", error);
                alert("Failed to copy file");
            }
        }

        window.onload = getFiles;  // Load file list when page loads
    </script>
</body>
</html>